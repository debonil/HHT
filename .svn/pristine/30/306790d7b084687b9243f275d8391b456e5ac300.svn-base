/*
 *  Licensed Materials - Property of Centre for railway information systems
 *  @author Ashutosh 
 */

import { Injectable } from '@angular/core';
import 'rxjs/add/operator/map';

declare var WLResourceRequest;

/*
  All resource requests to server will be injected through this.
*/
@Injectable()
export class BackendProvider {

  constructor() {
    
  }

  /*syncPassengerData(chartDate){
    return new Promise(resolve=>{
      let resourceRequest = new WLResourceRequest("/adapters/EHHT/syncPassengerData",WLResourceRequest.GET);
      resourceRequest.setQueryParameter("params", [chartDate]);
      resourceRequest.send().then((response)=>{
        resolve(response.responseText);
      },(failure)=>{
        resolve(failure);
      });
    });
  }*/

  postPassengerData(data){
    return new Promise(resolve=>{
      let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/pushPassenger",WLResourceRequest.GET);
      resourceRequest.setQueryParameter("params", [data]);
      resourceRequest.send().then((response)=>{
        var OBJ = {
          CODE : response.status,
          TEXT : response.responseText
        };
        resolve(OBJ);
        //resolve(response.responseText);
      },(failure)=>{
        resolve(failure);
      });
    });
  }

  postVacantberthData(data){
    return new Promise(resolve=>{
      let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/pushVacantberth",WLResourceRequest.GET);
      resourceRequest.setQueryParameter("params", [data]);
      resourceRequest.send().then((response)=>{
        alert('POST BERTH RESPONSE ' + JSON.stringify(response));
        var OBJ = {
          CODE : response.status,
          TEXT : response.responseText
        };
        resolve(OBJ);
        //resolve(response.responseText);
      },(failure)=>{
        resolve(failure);
      });
    });
  }

  postEftmasterdata(data){
    return new Promise(resolve=>{
      let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/pushEftmaster",WLResourceRequest.GET);
      resourceRequest.setQueryParameter("params", [data]);
      resourceRequest.send().then(response=>{
        var OBJ = {
          CODE : response.status,
          TEXT : response.responseText
        };
        resolve(OBJ);
      },failure=>{
        resolve(failure);
      });
    });
  }

  postCoachtimedata(data){
    return new Promise(resolve=>{
      let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/pushEftmaster",WLResourceRequest.GET);
      resourceRequest.setQueryParameter("params", [data]);
      resourceRequest.send().then(response=>{
        var OBJ = {
          CODE : response.status,
          TEXT : response.responseText
        };
        resolve(OBJ);
      },failure=>{
        resolve(failure);
      });
    });
  }

  /*
   * Authenticate user
   */
  authenticateUser(username,password) {
    console.log(username+password);
     return new Promise(
      resolve => {
        let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/userAuthentication",WLResourceRequest.GET);
        
        resourceRequest.setQueryParameter("params", [username,password]);
        resourceRequest.send().then((response) => {
          //alert("AUTH::"+JSON.stringify(response));
          var OBJ = {
            CODE : response.status,
            TEXT : response.responseText
          };
          resolve(OBJ);
        },(failure) => {
          alert("OBJ::"+JSON.stringify(failure));
          resolve(failure);
        }
    )
  })
}

getTrainAssignment(userId){
  return new Promise(resolve=>{
    let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/getTrainAssignment",WLResourceRequest.GET);
    resourceRequest.setQueryParameter("params", [userId]);
    console.log(userId);
    resourceRequest.send().then(response=>{
      console.log(response);
      //console.log('get train assignment response ' + JSON.stringify(response));
      //Added by DG for adding new field  ASSIGNED_COACHES to it.
      if(response.responseJSON.ASSIGNED_COACH&&response.responseJSON.ASSIGNED_COACH.length>0){
        response.responseJSON['ASSIGNED_COACHES']
        =response.responseJSON.ASSIGNED_COACH.map(val=>val.COACH_ID).sort(function (a,b) {
          //console.log(this.util);
          var cca=  a.replace(/[^A-Z\.]/g, '');
          var ccb= b.replace(/[^A-Z\.]/g, '');
          if (cca < ccb)
          return -1;
        if (cca > ccb)
          return 1;

          var cna= parseInt(a.replace(/[^0-9\.]/g, ''), 10);
          var cnb= parseInt(b.replace(/[^0-9\.]/g, ''), 10);
          if (cna < cnb)
            return -1;
          if (cna > cnb)
            return 1;
         return 0;
      });
      }
      
      //Added by DG for adding new field  ISL_ARR to it.
      if(response.responseJSON.ISL&&response.responseJSON.ISL.length>0){
        response.responseJSON['ISL_ARR']
        =response.responseJSON.ISL.map(val=>val.STN_CODE.trim());
      }
      
      var obj = {
        CODE : response.status,
        TEXT : response.responseJSON
      };
      resolve(obj);
    },failure=>{
      console.log('get train assignment failure ' + JSON.stringify(failure));
      resolve(failure);
    });
  });
}


/*
 * Fetching coach details
 */
getCoachDetails(user_id) {
 // alert('get coaches called');
     return new Promise(resolve => {
      let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/getCoacheDetails",WLResourceRequest.GET);
      resourceRequest.setQueryParameter("params", [user_id]);
      resourceRequest.send().then((response) => {
        var obj = {
          CODE : response.status,
          TEXT : response.responseText
        };
        resolve(obj) ;
      },(failure) => {
        resolve(failure);
      }
    )
  })
}


/*getCoachDetails(user_id) {
     return new Promise(resolve => {
      let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/getCoacheDetails",WLResourceRequest.GET);
      resourceRequest.setQueryParameter("params", [user_id]);
      resourceRequest.send().then((response) => {
          //resolve(response.responseText);
          resolve(response);
      },(failure) => {
        resolve(failure);
      }
    )
  })
}*/


 /*
  * Load current time
  */
getCurrentTime() {
  return new Promise(
    resolve => {
      let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/getCurrenttime",WLResourceRequest.GET);
      resourceRequest.send().then((response)=>{
        var obj = {
          CODE : response.status,
          TEXT : response.responseText,
          data : response.responseJSON,
        };
        resolve(obj) ;
      },(failure) => {
        resolve(failure);
      }
    );
  });
}


/*
 * Add new passengers
 */
addNewPassenger(dirtyPassenger) {
     return new Promise(
      resolve => {
        let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/pushPassenger",WLResourceRequest.GET);
        resourceRequest.setQueryParameter("params", [dirtyPassenger]);
        resourceRequest.send().then((response) => {
            resolve(response.responseText);
        },(failure) => {
          resolve(failure);
        }
    )
  })
}


/*
 * Load passengers for train 
 */
getPassenger(train_id,coach_id, loadTime) {
     return new Promise(
      resolve => {
        let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/getPassengers",WLResourceRequest.GET);
        resourceRequest.setQueryParameter("params", [train_id,coach_id,loadTime]);
        resourceRequest.send().then((response) => {
          var OBJ = {
            CODE : response.status,
            TEXT : response.responseJSON
          };
          resolve(OBJ);
        },(failure) => {
          resolve(failure);
        }
    )
  })
}


/*
 * loading Differential passenger
 */
getDifferentialPassenger(train_id, lastLoadtime, currentTime) {
     return new Promise(
      resolve => {
        let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/getDifferentialPassengers",WLResourceRequest.GET);
        resourceRequest.setQueryParameter("params", [train_id, lastLoadtime, currentTime]);
        resourceRequest.send().then((response) => {
            var OBJ = {
              CODE : response.status,
              TEXT : response.responseText
            };
            resolve(OBJ);
        },(failure) => {
          resolve(failure);
        }
    )
  });
}


/*
 * Add new passenger
 */
addPassenger(DOC) {
     return new Promise(
      resolve => {
        let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/addPassengers",WLResourceRequest.GET);
        resourceRequest.setQueryParameter("params", [DOC]);
        resourceRequest.send().then((response) => {
            resolve(response.responseText);
        },(failure) => {
          resolve(failure);
        }
    )
  })
}


/*
 * update passengers
 */
updatePassenger(DOC) {

     return new Promise(
      resolve => {

        let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/addPassengers",WLResourceRequest.GET);
        resourceRequest.setQueryParameter("params", [DOC]);
        resourceRequest.send().then((response) => {
            resolve(response.responseText);
        },(failure) => {
          resolve(failure);
        }
    )
  })
}


/*
 * Add vacant berth to server
 */
addNewVacantBerth(dirtyBerth) {

     return new Promise(
      resolve => {

        let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/pushVacantberth",WLResourceRequest.GET);
        resourceRequest.setQueryParameter("params", [dirtyBerth]);
        resourceRequest.send().then((response) => {
            resolve(response.responseText);
        },(failure) => {
          resolve(failure);
        }
    )
  })
}


/*
 * Load vacant berths
 */
getVacantBerth(train_id, coach_id, loadTime) {
     return new Promise(
      resolve => {
        let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/getVacantberths",WLResourceRequest.GET);
        resourceRequest.setQueryParameter("params", [train_id, coach_id, loadTime]);
        resourceRequest.send().then((response) => {
          var OBJ = {
            CODE : response.status,
            TEXT : response.responseText
          };
          resolve(OBJ);
            //resolve(response.responseText);
        },(failure) => {
          resolve(failure);
        }
    )
  })
}

getDifferentialVacantberth(train_id, lastLoadtime, currentTime) {
     return new Promise(
      resolve => {
        let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/getDifferentialVacantberth",WLResourceRequest.GET);
        resourceRequest.setQueryParameter("params", [train_id, lastLoadtime, currentTime]);
        resourceRequest.send().then((response) => {
            var OBJ = {
              CODE : response.status,
              TEXT : response.responseText
            };
            resolve(OBJ);
        },(failure) => {
          resolve(failure);
        }
    )
  });
}

/*
 * Add new vacant berth
 */
addVacantBerth(DOC) {

     return new Promise(
      resolve => {

        let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/addVacantBerths",WLResourceRequest.GET);
        resourceRequest.setQueryParameter("params", [DOC]);
        resourceRequest.send().then((response) => {
            resolve(response.responseText);
        },(failure) => {
          resolve(failure);
        }
    )
  })
}


/*
 * update vacant berth
 */
updateVacantBerth(DOC) {

     return new Promise(
      resolve => {

        let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/updateVacantBerths",WLResourceRequest.GET);
        resourceRequest.setQueryParameter("params", [DOC]);
        resourceRequest.send().then((response) => {
            resolve(response.responseText);
        },(failure) => {
          resolve(failure);
        }
    )
  })
}


/*
 * Update coach time
 */
updateCoachTime(train_id,coach_id,remote_loc_no,src_ch_number,checking_start_time,checking_end_time,upload_time,device_no,systime) {

     return new Promise(
      resolve => {

        let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/updateCoachTime",WLResourceRequest.GET);
        resourceRequest.setQueryParameter("params", [train_id,coach_id,remote_loc_no,src_ch_number,checking_start_time,checking_end_time,upload_time,device_no,systime]);
        resourceRequest.send().then((response) => {
            resolve(response.responseText);
        },(failure) => {
          resolve(failure);
        }
    )
  })
}


/*
 * load coach time
 */
getCoachTime(trainId) {
     return new Promise(
      resolve => {
        let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/getCoachTime",WLResourceRequest.GET);
        resourceRequest.setQueryParameter("params", [trainId]);
        resourceRequest.send().then((response) => {
          var OBJ = {
            CODE : response.status,
            TEXT : response.responseText
          };
            //resolve(response.responseText);
            resolve(OBJ);
        },(failure) => {
          resolve(failure);
        }
    )
  })
}

/*
 * Load Route for given train
 */
loadRoute(train_number) {

     return new Promise(
      resolve => {

        let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/getRoute",WLResourceRequest.GET);
        resourceRequest.setQueryParameter("params", [train_number]);
        resourceRequest.send().then((response) => {
            resolve(response.responseText);
        },(failure) => {
          resolve(failure);
        }
    )
  })
}


/*
 * Load master fare
 */
getDynamicFare(trainId) {
     return new Promise(
      resolve => {
        let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/getDynamicFare",WLResourceRequest.GET);
        resourceRequest.setQueryParameter("params", [trainId]);
        resourceRequest.send().then((response) => {
          var OBJ = {
            CODE : response.status,
            TEXT : response.responseText
          };
          resolve(OBJ);
            //resolve(response.responseText);
        },(failure) => {
          resolve(failure);
        }
    )
  })
}

/*
 * Load EFT Details
 */
getEFTDetails(trainId) {
     return new Promise(
      resolve => {
        let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/getEFTDetails",WLResourceRequest.GET);
        resourceRequest.setQueryParameter("params", [trainId]);
        resourceRequest.send().then((response) => {
          var OBJ = {
            CODE : response.status,
            TEXT : response.responseText
          };
          resolve(OBJ);
            //resolve(response.responseText);
        },(failure) => {
          resolve(failure);
        }
    )
  })
}

/*
 * Load ISL Details
 */
getISL(trainNo) {
     return new Promise(
      resolve => {
        let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/getISL",WLResourceRequest.GET);
        resourceRequest.setQueryParameter("params", [trainNo]);
        resourceRequest.send().then((response) => {
          var OBJ = {
            CODE : response.status,
            TEXT : response.responseText
          };
          resolve(OBJ);
           // resolve(response.responseText);
        },(failure) => {
          resolve(failure);
        }
    )
  })
}


/*
 * Load Waitlist
 */
getWaitlist(trainId, loadTime) {
     return new Promise(
      resolve => {
        let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/getWaitlist",WLResourceRequest.GET);
        resourceRequest.setQueryParameter("params", [trainId, loadTime]);
        resourceRequest.send().then((response) => {
            //resolve(response.responseText);
            console.log("response");
            //console.log( [trainId, loadTime]);
            console.log(response);
            (response);
            var OBJ = {
              CODE : response.status,
              TEXT : response.responseJSON
            };
            resolve(OBJ);
        },(failure) => {
          resolve(failure);
        }
    )
  })
}


/*
 * Load E tickets dropped passengers
 */
loaddroppedETickets(train_id) {
     return new Promise(
      resolve => {
        let resourceRequest = new WLResourceRequest("/adapters/ADAPTER_HHT/droppedETickets",WLResourceRequest.GET);
        resourceRequest.setQueryParameter("params", [train_id]);
        resourceRequest.send().then((response) => {
          var OBJ = {
            CODE : response.status,
            TEXT : response.responseText
          };
          resolve(OBJ);
            //resolve(response.responseText);
        },(failure) => {
          resolve(failure);
        }
    )
  })
}


}
